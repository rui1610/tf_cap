name: Setup infrastructure for app

on:
  workflow_dispatch:

  pull_request:
    types: [closed]
    branches:
      - main

env:
  TARGET_BRANCH: main
  CF_METADATA_FILENAME: cloudfoundry.tfvars

# Taken from https://github.com/hashicorp/setup-terraform
jobs:
  check-if-cf-file-exists:
    name: Check if Cloudfoundry metadata is known
    runs-on: ubuntu-latest
    outputs:
      cf_metadatafile_exists: ${{ steps.cf_metadata_exists.outputs.cf_metadatafile_exists }}
      cloudfoundry_org_name: ${{ steps.cf_metadata_exists.outputs.cloudfoundry_org_name }}
      cloudfoundry_org_id: ${{ steps.cf_metadata_exists.outputs.cloudfoundry_org_id }}
      cloudfoundry_space_id: ${{ steps.cf_metadata_exists.outputs.cloudfoundry_space_id }}
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3
      with:
        ref: ${{ env.TARGET_BRANCH }}
    - name: Check existance of CF file
      id: cf_metadata_exists
      working-directory: terraform
      shell: bash
      run: |
        if [ -f "$CF_METADATA_FILENAME" ]; then
            echo "cf_metadatafile_exists=true" >> $GITHUB_OUTPUT && echo "The CF metadata file exists!"
            source "$CF_METADATA_FILENAME"
            echo "cloudfoundry_org_name=$cloudfoundry_org_name" >> $GITHUB_OUTPUT 
            echo "cloudfoundry_org_id=$cloudfoundry_org_id" >> $GITHUB_OUTPUT 
            echo "cloudfoundry_space_id=$cloudfoundry_space_id" >> $GITHUB_OUTPUT 
        else 
            echo "cf_metadatafile_exists=false" >> $GITHUB_OUTPUT && echo "The CF metadata file doesn't exist!"
        fi
    - name: "Get repo folder in container"
      shell: bash
      run: |
        echo "REPO_NAME=/__w/$(basename ${{ github.repository }})/$(basename ${{ github.repository }})" >> $GITHUB_ENV

  infrastructure1:
    if: ${{needs.check-if-cf-file-exists.outputs.cf_metadatafile_exists == 'false'}}
    name: Run Terraform script
    runs-on: ubuntu-latest
    needs: [check-if-cf-file-exists]
    outputs:
      cloudfoundry_org_name: ${{ steps.terraform_output.outputs.cloudfoundry_org_name }}
      cloudfoundry_org_id: ${{ steps.terraform_output.outputs.cloudfoundry_org_id }}
      subaccount_id: ${{ steps.terraform_output.outputs.subaccount_id }}
      subaccount_name: ${{ steps.terraform_output.outputs.subaccount_name }}
      cloudfoundry_space_id: ${{ steps.terraform_output.outputs.cloudfoundry_space_id }}
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3
      with:
        ref: ${{ env.TARGET_BRANCH }}
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_wrapper: false
    - name: Terraform Init
      id: init
      run: terraform init
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TF_ACTION_WORKING_DIR: 'terraform'
      working-directory: terraform
      shell: bash
    - name: Terraform Apply
      id: terraform_apply
      run: terraform apply -auto-approve
      env:
        TARGET_BRANCH: ${{ env.TARGET_BRANCH }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TF_ACTION_WORKING_DIR: 'terraform'
        BTP_USERNAME: ${{ secrets.BTP_USERNAME }}
        BTP_PASSWORD: ${{ secrets.BTP_PASSWORD }}
        CF_USER: ${{ secrets.BTP_USERNAME }}
        CF_PASSWORD: ${{ secrets.BTP_PASSWORD }}
      working-directory: terraform
      shell: bash
    - name: Terraform Output
      id: terraform_output
      run: |
        echo "cloudfoundry_org_name=$(terraform output cloudfoundry_org_name)" >> $GITHUB_OUTPUT 
        echo "cloudfoundry_org_id=$(terraform output cloudfoundry_org_id)" >> $GITHUB_OUTPUT 
        echo "subaccount_id=$(terraform output subaccount_id)" >> $GITHUB_OUTPUT 
        echo "subaccount_name=$(terraform output subaccount_name)" >> $GITHUB_OUTPUT
        echo "cloudfoundry_space_id=$(terraform output cloudfoundry_space_id)" >> $GITHUB_OUTPUT 

        echo "cloudfoundry_space_id=$(terraform output cloudfoundry_space_id)" > $CF_METADATA_FILENAME
        echo "cloudfoundry_org_id=$(terraform output cloudfoundry_org_id)" >> $CF_METADATA_FILENAME
        echo "cloudfoundry_org_name=$(terraform output cloudfoundry_org_name)" >> $CF_METADATA_FILENAME
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TF_ACTION_WORKING_DIR: 'terraform'
      working-directory: terraform
      shell: bash

    - name: Commit and push changes
      run: |
        git add -A
        git config user.email "tfbtpbot@users.noreply.github.com"
        git config user.name "[tf_btp bot] storage of cf info"
        git diff --quiet && git diff --staged --quiet || git commit -m "[tf_btp bot] Store retrieved cloudfoundry metadata."
        git push origin ${{ env.TARGET_BRANCH }}

  build-cap-application:
    name: Build CAP application
    runs-on: ubuntu-latest
    needs: check-if-cf-file-exists
    container:
      image: ghcr.io/rui1610/tf_cap:main
      options: --user root
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3
#    - name: "Get repo folder in container"
#      shell: bash
#      run: |
#        echo "REPO_NAME=/__w/$(basename ${{ github.repository }})/$(basename ${{ github.repository }})" >> $GITHUB_ENV
    - name: 'Start build process for CAP app'
      working-directory: ${{ env.REPO_NAME }}
      shell: bash
      run: |
        cd demo-app
        cds add hana --for hybrid
        cds add mta
        mbt build -t gen --mtar mta.tar
        ls -l

  deploy-cap-application:
    name: Deploy CAP application
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/rui1610/tf_cap:main
      options: --user root    
    needs: [build-cap-application, infrastructure1]
    if: |
      needs.build-cap-application.result == 'success' && (needs.infrastructure1.result == 'skipped' || needs.infrastructure1.result == 'success')
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3
#    - name: "Get repo folder in container"
#      shell: bash
#      run: |
#        echo "REPO_NAME=/__w/$(basename ${{ github.repository }})/$(basename ${{ github.repository }})" >> $GITHUB_ENV
    - name: 'Start build process for CAP app'
      working-directory: ${{ env.REPO_NAME }}
      shell: bash
      env:
        SUBACCOUNT_ID: ${{needs.infrastructure1.outputs.subaccount_id}}
        SUBACCOUNT_NAME: ${{needs.infrastructure1.outputs.subaccount_name}}
        CF_ORG_ID: ${{needs.infrastructure1.outputs.cloudfoundry_org_id}}
        CF_ORG_NAME: ${{needs.infrastructure1.outputs.cloudfoundry_org_name}}
        CF_SPACE_ID: ${{needs.infrastructure1.outputs.cloudfoundry_space_id}}
        CF_ORG_ID_FILE: ${{needs.check-if-cf-file-exists.outputs.cloudfoundry_org_id}}
        CF_ORG_NAME_FILE: ${{needs.check-if-cf-file-exists.outputs.cloudfoundry_org_name}}
        CF_SPACE_ID_FILE: ${{needs.check-if-cf-file-exists.outputs.cloudfoundry_space_id}}
      run: |
        cd demo-app
        cf api https://api.cf.us10.hana.ondemand.com
        cf auth ${{ secrets.BTP_USERNAME }} "${{ secrets.BTP_PASSWORD }}"
        if [ -f "$CF_METADATA_FILENAME" ]; then
          cf target -o $CF_ORG_NAME_FILE -s development
        else 
          cf target -o $CF_ORG_NAME -s development
        fi
        cds deploy --to hana --profile hybrid
        cf deploy gen/mta.tar
